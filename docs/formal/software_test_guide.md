# Software Test Guide

**Version:** 4.1.0<br>
**Date:** 2025-12-18<br>
**SPDX-License-Identifier:** BSD-3-Clause<br>
**License File:** See the LICENSE file in the project root<br>
**Copyright:** © 2025 Michael Gardner, A Bit of Help, Inc.<br>
**Status:** Released

---

## 1. Introduction

### 1.1 Purpose

This Software Test Guide (STG) describes the test strategy, organization, and execution procedures for the Functional library.

### 1.2 Scope

This document covers:
- Test categories and their purposes
- Test directory structure and naming conventions
- Test framework usage
- Test execution commands
- Guidelines for writing new tests

### 1.3 References

- [Software Requirements Specification](software_requirements_specification.md)
- [Software Design Specification](software_design_specification.md)

---

## 2. Test Strategy

### 2.1 Test Categories

| Category | Location | Purpose | Target |
|----------|----------|---------|--------|
| Unit Tests | `test/unit/` | Test individual packages | ≥90% coverage |
| SPARK Tests | `test/spark/` | Verify SPARK instantiations | 100% legality |
| Integration Tests | `test/integration/` | Cross-package tests | Key workflows |

### 2.2 Testing Philosophy

1. **Test Behavior, Not Implementation** - Tests verify observable behavior
2. **One Assertion Per Concept** - Each test validates one logical concept
3. **Descriptive Names** - Test names describe what is being tested
4. **No Mocking Core Types** - Result/Option/Either are tested directly
5. **SPARK Verification** - Domain types verified with gnatprove

---

## 3. Test Organization

### 3.1 Directory Structure

```
test/
├── common/                          # Shared test infrastructure
│   ├── test_framework.ads           # Test framework spec
│   └── test_framework.adb           # Test framework impl
├── config/                          # Test configuration
│   └── functional_tests_config.ads  # Auto-generated by Alire
├── unit/                            # Unit test suites
│   ├── test_result.adb              # Result tests
│   ├── test_option.adb              # Option tests
│   ├── test_either.adb              # Either tests
│   ├── test_try.adb                 # Try tests
│   ├── test_try_option.adb          # Try Option tests
│   ├── test_try_map_to_result.adb   # Map_To_Result tests
│   ├── test_try_map_to_result_with_param.adb
│   ├── test_scoped.adb              # Scoped tests
│   └── unit_runner.adb              # Unit test runner
├── spark/                           # SPARK verification tests
│   ├── spark_instantiations.ads     # SPARK-compatible instantiations
│   └── spark_instantiations.adb
├── functional_test.gpr              # Test GPR project
└── alire/                           # Alire dependencies (generated)
```

### 3.2 Naming Conventions

| Item | Convention | Example |
|------|------------|---------|
| Test file | `test_<module>.adb` | `test_result.adb` |
| Test procedure | `Test_<Operation>_<Scenario>` | `Test_Map_Success` |
| Test package | `Test_<Module>` | `Test_Result` |

### 3.3 GPR Projects

| Project | Purpose |
|---------|---------|
| `functional_test.gpr` | Builds all test executables |
| Extends `functional.gpr` | Inherits library configuration |

---

## 4. Test Framework

### 4.1 Framework Overview

The Functional library uses a lightweight custom test framework (`test/common/test_framework.ads`).

### 4.2 API

```ada
package Test_Framework is
   --  Call at end of test suite
   procedure Register_Results
     (Suite_Name   : String;
      Test_Count   : Natural;
      Passed_Count : Natural);

   --  Check final status across all suites
   function All_Passed return Boolean;

   --  Print summary and return exit code
   procedure Report_And_Exit;
end Test_Framework;
```

### 4.3 Usage Pattern

```ada
with Test_Framework;

procedure Test_My_Module is
   Test_Count   : Natural := 0;
   Passed_Count : Natural := 0;

   procedure Assert (Condition : Boolean; Name : String) is
   begin
      Test_Count := Test_Count + 1;
      if Condition then
         Passed_Count := Passed_Count + 1;
         Put_Line ("[PASS] " & Name);
      else
         Put_Line ("[FAIL] " & Name);
      end if;
   end Assert;

begin
   --  Tests go here
   Assert (Is_Ok (Result), "Ok creates success");
   Assert (not Is_Error (Result), "Ok is not error");

   --  Register results
   Test_Framework.Register_Results
     ("My_Module", Test_Count, Passed_Count);
end Test_My_Module;
```

---

## 5. Test Execution

### 5.1 Running All Tests

```bash
make test-all
```

Or manually:

```bash
alr build
./bin/test/unit_runner
```

### 5.2 Running Specific Suites

```bash
# Run individual test
./bin/test/test_result

# Run unit tests only
make test-unit
```

### 5.3 Expected Output

```
========================================
Test Summary: Functional.Result
========================================
Total tests: 84
Passed: 84
Failed: 0
========================================
All tests passed!
```

### 5.4 SPARK Verification

```bash
# Run SPARK proof
make spark-prove

# Run SPARK legality check only
make spark-check
```

---

## 6. Test Details

### 6.1 Unit Tests

#### Result Tests (`test_result.adb`)

Tests all Result operations:
- Constructors: Ok, Error
- Queries: Is_Ok, Is_Error, Value, Get_Error
- Transformations: Map, Map_Error, And_Then, Or_Else
- Extraction: Unwrap_Or, Match

#### Option Tests (`test_option.adb`)

Tests all Option operations:
- Constructors: Some, None
- Queries: Is_Some, Is_None, Value
- Transformations: Map, And_Then, Or_Else, Filter
- Extraction: Unwrap_Or, Match

#### Either Tests (`test_either.adb`)

Tests all Either operations:
- Constructors: Left, Right
- Queries: Is_Left, Is_Right, Left_Value, Right_Value
- Transformations: Map_Left, Map_Right, Fold

#### Try Tests (`test_try.adb`, `test_try_option.adb`, `test_try_map_to_result.adb`)

Tests exception bridging:
- Success path (no exception)
- Exception path (exception caught)
- Exception mapping (correct error kind)
- Default error kind (unmapped exceptions)

#### Scoped Tests (`test_scoped.adb`)

Tests RAII guards:
- Normal cleanup path
- Exception in guarded block
- Exception in Release (suppressed)

### 6.2 SPARK Tests

#### SPARK Instantiations (`spark_instantiations.ads`)

Verifies Result, Option, Either can be instantiated in SPARK_Mode:

```ada
pragma SPARK_Mode (On);

package SPARK_Instantiations is
   type Error_Kind is (E1, E2);

   package Int_Result is new Functional.Result (Integer, Error_Kind);
   package Int_Option is new Functional.Option (Integer);
end SPARK_Instantiations;
```

---

## 7. Writing New Tests

### 7.1 Test Template

```ada
pragma Ada_2022;
--  ======================================================================
--  Test_New_Feature
--  ======================================================================
--  Copyright (c) 2025 Michael Gardner, A Bit of Help, Inc.
--  SPDX-License-Identifier: BSD-3-Clause
--  Purpose:
--    Unit tests for New_Feature. Target: 90%+ coverage.
--  ======================================================================

with Ada.Text_IO;    use Ada.Text_IO;
with Ada.Command_Line;
with Functional.New_Feature;
with Test_Framework;

procedure Test_New_Feature is

   Test_Count   : Natural := 0;
   Passed_Count : Natural := 0;

   procedure Assert (Condition : Boolean; Test_Name : String) is
   begin
      Test_Count := Test_Count + 1;
      if Condition then
         Passed_Count := Passed_Count + 1;
         Put_Line ("[PASS] " & Test_Name);
      else
         Put_Line ("[FAIL] " & Test_Name);
      end if;
   end Assert;

begin
   Put_Line ("========================================");
   Put_Line ("Testing: Functional.New_Feature");
   Put_Line ("========================================");
   New_Line;

   --  Test 1: Description
   declare
      --  Setup
   begin
      Assert (Condition, "Test description");
   end;

   --  Register and report
   New_Line;
   Put_Line ("========================================");
   Put_Line ("Total tests:" & Test_Count'Image);
   Put_Line ("Passed:" & Passed_Count'Image);
   Put_Line ("Failed:" & Natural'Image (Test_Count - Passed_Count));
   Put_Line ("========================================");

   Test_Framework.Register_Results
     ("New_Feature", Test_Count, Passed_Count);

   if Passed_Count = Test_Count then
      Put_Line ("All tests passed!");
      Ada.Command_Line.Set_Exit_Status (Ada.Command_Line.Success);
   else
      Put_Line ("SOME TESTS FAILED!");
      Ada.Command_Line.Set_Exit_Status (Ada.Command_Line.Failure);
   end if;
end Test_New_Feature;
```

### 7.2 Adding to GPR

Add new test to `functional_test.gpr`:

```ada
for Main use (
   "unit_runner.adb",
   "test_new_feature.adb"  --  Add new test
);
```

### 7.3 Mock Patterns

For Functional library tests, mocking is generally not needed since:
- Core types are pure (no I/O)
- Try tests use controlled exceptions
- Scoped tests use test resources

---

## 8. Traceability

### 8.1 Requirements to Tests

| Requirement | Test File | Test Procedures |
|-------------|-----------|-----------------|
| FR-R01..R12 | test_result.adb | Test_Ok_*, Test_Error_*, Test_Map_*, etc. |
| FR-O01..O10 | test_option.adb | Test_Some_*, Test_None_*, Test_Map_*, etc. |
| FR-E01..E08 | test_either.adb | Test_Left_*, Test_Right_*, Test_Map_*, etc. |
| FR-T01..T07 | test_try*.adb | Test_Success_*, Test_Exception_*, etc. |
| FR-S01..S04 | test_scoped.adb | Test_Guard_*, Test_Release_*, etc. |
| NFR-07 | spark_instantiations.ads | SPARK legality verification |

---

## 9. Test Maintenance

### 9.1 When to Update Tests

- **New Operation Added**: Add tests for new operation
- **Behavior Changed**: Update affected tests
- **Bug Fixed**: Add regression test
- **API Signature Changed**: Update test instantiations

### 9.2 Quality Guidelines

- Each public operation should have ≥1 test
- Test both success and failure paths
- Test edge cases (empty, boundary values)
- Keep tests independent (no shared state)

### 9.3 CI Integration

Tests run automatically on:
- Pull request creation
- Push to main branch
- Release tag creation

---

## 10. Appendices

### Appendix A: Naming Conventions Summary

| Item | Pattern | Example |
|------|---------|---------|
| Test file | `test_<module>.adb` | `test_result.adb` |
| Test procedure | `Test_<Op>_<Scenario>` | `Test_Map_Success` |
| Assert message | `<Op> <expected behavior>` | `"Map transforms value"` |

### Appendix B: Change History

| Version | Date | Changes |
|---------|------|---------|
| 4.1.0 | 2025-12-18 | Added test warning suppressions |
| 4.0.0 | 2025-12-12 | Added Map_To_Result tests |
| 3.0.0 | 2025-11-30 | Initial test framework |

---

**Document Control:**
- Version: 4.1.0
- Last Updated: 2025-12-18
- Status: Released
